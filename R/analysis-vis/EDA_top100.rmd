
---
title: "Exploration of drug-spending - Andy Pickering"
output: 
  html_document: 
    keep_md: yes
    toc: yes
  html_notebook: 
    toc: yes
---


## Introduction

Modified from the automatically generated notebook for the `drug-spending` dataset found at: 
https://data.world/data4democracy/drug-spending, showcasing the use of the `data.world` R package. * Learn more at https://github.com/datadotworld/data.world-r


### Load packages
```{r}
library(data.world)
suppressPackageStartupMessages(library(dplyr))
suppressPackageStartupMessages(library(ggplot2))
library(tibble)
```


### List all tables in the **drug-spending** dataset:
```{r list tables}
# Datasets are referenced by their URL or path
dataset_key <- "https://data.world/data4democracy/drug-spending"
# List tables available for SQL queries
tables_qry <- data.world::qry_sql("SELECT * FROM Tables")
tables_df <- data.world::query(tables_qry, dataset = dataset_key)
# See what is in it
tables_df$tableName
```



## Here I will only look at the 'spending_all_top100.csv' data
```{r}
  spend_qry <- data.world::qry_sql(sprintf("SELECT * FROM spending_all_top100"))
  spend_df  <- data.world::query(spend_qry, dataset = dataset_key)
  glimpse(spend_df)
```


### Which drugs had largest total spending? 
- Hmmm **Note** the top 4 are all insulin, and seem to be the same drug, but are enetered separately for some reason?

```{r}
spend_df %>% arrange(desc(total_spending)) %>% select(drugname_brand,drugname_generic,total_spending) %>% head(20)
##spend_df %>% arrange(desc(total_spending)) %>% select(drugname_generic,total_spending) %>% top_n(5) %>%head ```
```

### The generic drugname 'INSULIN GLARGINE,HUM.REC.ANLOG' appears in 13 separate rows, and is associated w/ 3 different 'drugname_brand's. Should these be combined? Perhaps grouped by the brand name?

```{r}
spend_df %>% filter(drugname_generic=='INSULIN GLARGINE,HUM.REC.ANLOG') %>% head(20)
```


### Turns out there are a lot of repeated drug names in the dataset:

```{r}
print( paste('Out of ',nrow(spend_df),' rows, there are ',length(unique(spend_df$drugname_generic)),' unique generic names '))
```

```{r}
print( paste('Out of ',nrow(spend_df),' rows, there are ',length(unique(spend_df$drugname_brand)),' unique brand names '))
```


### Try plotting total spending by year
```{r}
spend_df %>%
        group_by(year) %>%
        summarise(tot=sum(total_spending)) %>%
        ggplot(aes(year,tot)) +
        geom_bar(stat='identity',aes(fill=year))
```


